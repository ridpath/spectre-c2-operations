
import React, { useState } from 'react';
import { 
  Target, 
  Zap, 
  AlertTriangle, 
  Clock, 
  Activity, 
  CheckCircle,
  XCircle,
  Loader2,
  Shield,
  Radio,
  Satellite,
  TowerControl,
  Flame,
  Bug
} from 'lucide-react';
import { ExploitChain, ExploitStep, OrbitalAsset } from '../types';

const SatelliteExploitOrchestrator: React.FC = () => {
  const [selectedChain, setSelectedChain] = useState<ExploitChain | null>(null);
  const [isExecuting, setIsExecuting] = useState(false);
  const [currentStep, setCurrentStep] = useState(0);
  const [executionLog, setExecutionLog] = useState<string[]>([]);
  const [executionStatus, setExecutionStatus] = useState<'idle' | 'running' | 'success' | 'failed'>('idle');

  const exploitChains: ExploitChain[] = [
    {
      id: 'cubesat-takeover',
      name: 'CubeSat Ground Station Impersonation',
      target_type: 'cubesat',
      opsec_risk: 'high',
      estimated_duration: 120,
      success_rate: 0.72,
      steps: [
        { action: 'scan_beacon', duration: 30 },
        { action: 'decode_tle', duration: 5 },
        { action: 'calculate_doppler', duration: 2 },
        { action: 'forge_tc_packet', payload: 'reboot_cmd' },
        { action: 'transmit_uplink', power: 'max' },
        { action: 'monitor_telemetry', duration: 60 }
      ]
    },
    {
      id: 'weather-sat-hijack',
      name: 'Weather Satellite Telemetry Injection',
      target_type: 'weather',
      opsec_risk: 'medium',
      estimated_duration: 200,
      success_rate: 0.85,
      steps: [
        { action: 'lrpt_decode', duration: 120 },
        { action: 'analyze_frame_structure' },
        { action: 'craft_false_imagery' },
        { action: 'inject_lrpt_frame' },
        { action: 'verify_downlink' }
      ]
    },
    {
      id: 'comsat-denial',
      name: 'Commercial Satellite Denial of Service',
      target_type: 'comsat',
      opsec_risk: 'extreme',
      estimated_duration: 300,
      success_rate: 0.95,
      legal_warning: 'CRITICAL: Illegal without authorization',
      steps: [
        { action: 'identify_transponder' },
        { action: 'calculate_link_budget' },
        { action: 'generate_jamming_signal' },
        { action: 'transmit_interference', duration: 300 }
      ]
    },
    {
      id: 'amateur-beacon-spoof',
      name: 'Amateur Satellite Beacon Spoofing',
      target_type: 'amateur',
      opsec_risk: 'low',
      estimated_duration: 45,
      success_rate: 0.91,
      steps: [
        { action: 'decode_ax25_beacon', duration: 15 },
        { action: 'clone_callsign' },
        { action: 'craft_spoofed_beacon', payload: 'false_telemetry' },
        { action: 'transmit_beacon', duration: 30 }
      ]
    },
    {
      id: 'military-recon',
      name: 'Military Satellite Reconnaissance',
      target_type: 'military',
      opsec_risk: 'extreme',
      estimated_duration: 180,
      success_rate: 0.38,
      legal_warning: 'EXTREME RISK: Federal offense',
      steps: [
        { action: 'passive_signal_collection', duration: 120 },
        { action: 'protocol_fingerprinting', duration: 30 },
        { action: 'frequency_analysis', duration: 30 },
        { action: 'export_intelligence' }
      ]
    }
  ];

  const handleExecuteChain = async () => {
    if (!selectedChain) return;

    setIsExecuting(true);
    setCurrentStep(0);
    setExecutionLog([]);
    setExecutionStatus('running');

    for (let i = 0; i < selectedChain.steps.length; i++) {
      const step = selectedChain.steps[i];
      setCurrentStep(i);
      
      const logMsg = `[${new Date().toLocaleTimeString()}] Executing: ${step.action.replace(/_/g, ' ')}...`;
      setExecutionLog(prev => [...prev, logMsg]);

      await new Promise(resolve => setTimeout(resolve, (step.duration || 3) * 1000));

      const success = Math.random() < selectedChain.success_rate;
      if (!success && i > selectedChain.steps.length / 2) {
        setExecutionLog(prev => [...prev, `[ERROR] Step failed: ${step.action}`]);
        setExecutionStatus('failed');
        setIsExecuting(false);
        return;
      }

      setExecutionLog(prev => [...prev, `[SUCCESS] ${step.action.replace(/_/g, ' ')} completed`]);
    }

    setExecutionStatus('success');
    setIsExecuting(false);
    setExecutionLog(prev => [...prev, `[COMPLETE] Exploit chain executed successfully`]);
  };

  const getRiskColor = (risk: string) => {
    switch (risk) {
      case 'low': return 'text-green-400 bg-green-500/10 border-green-500/30';
      case 'medium': return 'text-yellow-400 bg-yellow-500/10 border-yellow-500/30';
      case 'high': return 'text-orange-400 bg-orange-500/10 border-orange-500/30';
      case 'extreme': return 'text-red-400 bg-red-500/10 border-red-500/30';
      default: return 'text-blue-400 bg-blue-500/10 border-blue-500/30';
    }
  };

  const getTargetIcon = (type: string) => {
    switch (type) {
      case 'cubesat': return <Satellite className="text-blue-400" size={20} />;
      case 'weather': return <Activity className="text-cyan-400" size={20} />;
      case 'comsat': return <TowerControl className="text-purple-400" size={20} />;
      case 'military': return <Shield className="text-red-400" size={20} />;
      default: return <Radio className="text-gray-400" size={20} />;
    }
  };

  return (
    <div className="h-full flex flex-col gap-8 animate-in fade-in duration-500">
      <header className="flex flex-col gap-1">
        <h2 className="text-2xl font-black text-emerald-400 uppercase tracking-tighter flex items-center gap-3">
          <Target size={24} /> Satellite Exploit Orchestrator
        </h2>
        <p className="text-[10px] text-slate-500 uppercase font-black tracking-[0.2em] mt-1">
          Automated Attack Chain Execution for Satellite Penetration Testing
        </p>
      </header>

      <div className="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-8 overflow-hidden">
        <div className="lg:col-span-5 flex flex-col gap-4 overflow-y-auto">
          <section className="bg-slate-900/40 border border-slate-800 rounded-[2.5rem] p-8">
            <h3 className="text-sm font-black text-white uppercase tracking-tight mb-6 flex items-center gap-2">
              <Zap size={16} /> Pre-Built Attack Chains
            </h3>

            <div className="space-y-3">
              {exploitChains.map((chain) => (
                <button
                  key={chain.id}
                  onClick={() => setSelectedChain(chain)}
                  className={`w-full p-6 rounded-2xl border text-left transition-all relative overflow-hidden group
                    ${selectedChain?.id === chain.id
                      ? 'bg-emerald-500/10 border-emerald-500/40'
                      : 'bg-slate-900/40 border-slate-800 hover:border-slate-700'}`}
                >
                  <div className="flex items-start gap-4">
                    <div className={`p-3 rounded-xl ${selectedChain?.id === chain.id ? 'bg-emerald-500/20' : 'bg-black/40'}`}>
                      {getTargetIcon(chain.target_type)}
                    </div>
                    <div className="flex-1">
                      <h4 className="text-xs font-black text-white uppercase tracking-tight mb-2">{chain.name}</h4>
                      
                      <div className="flex gap-2 flex-wrap mb-3">
                        <span className={`text-[8px] font-black uppercase px-2 py-1 rounded border ${getRiskColor(chain.opsec_risk)}`}>
                          {chain.opsec_risk} risk
                        </span>
                        <span className="text-[8px] font-black text-slate-500 uppercase border border-slate-700 px-2 py-1 rounded">
                          {chain.target_type}
                        </span>
                        <span className="text-[8px] font-black text-emerald-500 uppercase border border-emerald-700 px-2 py-1 rounded">
                          {(chain.success_rate * 100).toFixed(0)}% success
                        </span>
                      </div>

                      <div className="flex items-center gap-2 text-[10px] text-slate-500">
                        <Clock size={10} />
                        <span>{Math.floor(chain.estimated_duration / 60)}m {chain.estimated_duration % 60}s</span>
                        <span className="mx-2">•</span>
                        <span>{chain.steps.length} steps</span>
                      </div>

                      {chain.legal_warning && (
                        <div className="mt-3 p-2 bg-red-500/10 border border-red-500/30 rounded-lg flex items-center gap-2">
                          <AlertTriangle className="text-red-400" size={12} />
                          <p className="text-[8px] font-black text-red-400 uppercase">{chain.legal_warning}</p>
                        </div>
                      )}
                    </div>
                  </div>
                </button>
              ))}
            </div>
          </section>
        </div>

        <div className="lg:col-span-7 flex flex-col gap-6">
          <section className="bg-slate-900/40 border border-slate-800 rounded-[2.5rem] p-10 flex-1 overflow-hidden flex flex-col">
            {!selectedChain ? (
              <div className="flex flex-col items-center justify-center h-full text-slate-500">
                <Target size={64} className="mb-6 opacity-20" />
                <p className="text-sm font-black uppercase">Select an attack chain</p>
                <p className="text-[10px] text-slate-600 mt-2">Choose a pre-built exploit sequence from the left panel</p>
              </div>
            ) : (
              <div className="flex flex-col h-full">
                <div className="flex justify-between items-start mb-8">
                  <div>
                    <h3 className="text-xl font-black text-white uppercase tracking-tight mb-2">{selectedChain.name}</h3>
                    <div className="flex gap-3">
                      <span className={`text-[10px] font-black uppercase px-3 py-1 rounded border ${getRiskColor(selectedChain.opsec_risk)}`}>
                        OpSec: {selectedChain.opsec_risk}
                      </span>
                      <span className="text-[10px] font-black text-white uppercase border border-slate-700 px-3 py-1 rounded">
                        Success: {(selectedChain.success_rate * 100).toFixed(0)}%
                      </span>
                    </div>
                  </div>
                  <button
                    onClick={handleExecuteChain}
                    disabled={isExecuting}
                    className="px-8 py-4 bg-emerald-600 hover:bg-emerald-500 disabled:bg-slate-700 disabled:cursor-not-allowed text-white rounded-2xl text-[10px] font-black uppercase tracking-widest flex items-center gap-3 shadow-xl shadow-emerald-900/40 transition-all"
                  >
                    {isExecuting ? (
                      <>
                        <Loader2 size={16} className="animate-spin" /> Executing...
                      </>
                    ) : (
                      <>
                        <Flame size={16} /> Execute Chain
                      </>
                    )}
                  </button>
                </div>

                <div className="flex-1 flex flex-col gap-6 overflow-hidden">
                  <div className="bg-black/40 border border-white/5 rounded-2xl p-6">
                    <h4 className="text-xs font-black text-white uppercase mb-4">Attack Steps</h4>
                    <div className="space-y-2">
                      {selectedChain.steps.map((step, i) => (
                        <div 
                          key={i}
                          className={`p-4 rounded-xl border transition-all ${
                            i === currentStep && isExecuting
                              ? 'bg-emerald-500/10 border-emerald-500/30'
                              : i < currentStep && executionStatus === 'running'
                              ? 'bg-green-500/10 border-green-500/20'
                              : 'bg-slate-900/40 border-slate-800'
                          }`}
                        >
                          <div className="flex items-center gap-3">
                            <div className={`w-6 h-6 rounded-full flex items-center justify-center text-[10px] font-black ${
                              i === currentStep && isExecuting
                                ? 'bg-emerald-500 text-white'
                                : i < currentStep && executionStatus === 'running'
                                ? 'bg-green-500 text-white'
                                : 'bg-slate-700 text-slate-400'
                            }`}>
                              {i < currentStep && executionStatus === 'running' ? '✓' : i + 1}
                            </div>
                            <div className="flex-1">
                              <p className="text-xs font-black text-white uppercase">{step.action.replace(/_/g, ' ')}</p>
                              <div className="flex gap-3 mt-1">
                                {step.duration && (
                                  <span className="text-[8px] text-slate-500">{step.duration}s</span>
                                )}
                                {step.payload && (
                                  <span className="text-[8px] text-blue-400">payload: {step.payload}</span>
                                )}
                                {step.power && (
                                  <span className="text-[8px] text-orange-400">power: {step.power}</span>
                                )}
                              </div>
                            </div>
                            {i === currentStep && isExecuting && (
                              <Loader2 className="text-emerald-400 animate-spin" size={16} />
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>

                  <div className="flex-1 bg-black/60 border border-white/5 rounded-2xl p-6 overflow-hidden flex flex-col">
                    <h4 className="text-xs font-black text-white uppercase mb-4 flex items-center gap-2">
                      <Activity size={14} /> Execution Log
                    </h4>
                    <div className="flex-1 overflow-y-auto space-y-1 font-mono text-[10px]">
                      {executionLog.length === 0 ? (
                        <p className="text-slate-500">Waiting for execution...</p>
                      ) : (
                        executionLog.map((log, i) => (
                          <div key={i} className={`${log.includes('ERROR') ? 'text-red-400' : log.includes('SUCCESS') || log.includes('COMPLETE') ? 'text-emerald-400' : 'text-slate-400'}`}>
                            {log}
                          </div>
                        ))
                      )}
                    </div>
                  </div>

                  {executionStatus === 'success' && (
                    <div className="p-6 bg-emerald-500/10 border-2 border-emerald-500/30 rounded-2xl flex items-center gap-4">
                      <CheckCircle className="text-emerald-400" size={32} />
                      <div>
                        <h4 className="text-sm font-black text-emerald-400 uppercase">Exploit Chain Successful</h4>
                        <p className="text-[10px] text-slate-400 mt-1">All attack steps completed successfully</p>
                      </div>
                    </div>
                  )}

                  {executionStatus === 'failed' && (
                    <div className="p-6 bg-red-500/10 border-2 border-red-500/30 rounded-2xl flex items-center gap-4">
                      <XCircle className="text-red-400" size={32} />
                      <div>
                        <h4 className="text-sm font-black text-red-400 uppercase">Exploit Chain Failed</h4>
                        <p className="text-[10px] text-slate-400 mt-1">Attack sequence interrupted at step {currentStep + 1}</p>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            )}
          </section>
        </div>
      </div>
    </div>
  );
};

export default SatelliteExploitOrchestrator;
