
import React, { useState } from 'react';
import { Target, Play, ShieldAlert, Cpu, Settings2, Zap, Terminal as TerminalIcon, Search, ShieldCheck, Loader2 } from 'lucide-react';
import { ExploitModule, WinRMConnection } from '../types';

const VALIDATION_LIBRARY: ExploitModule[] = [
  { id: 'v-smb-01', name: 'Memory Corruption Analysis (SMBv1)', cve: 'CVE-2017-0144', platform: 'windows', rank: 'excellent', description: 'Assesses host susceptibility to buffer overflow within SMBv1 protocol handling.', options: { TARGET_PORT: 445 } },
  { id: 'v-spool-01', name: 'Service Driver Validation (Print Spooler)', cve: 'CVE-2021-1675', platform: 'windows', rank: 'great', description: 'Tests for improper validation of third-party printer drivers in spooler context.', options: { DRIVER_MIMIC: 'Xerox' } },
  { id: 'v-net-01', name: 'Cryptographic Protocol Fatigue (Netlogon)', cve: 'CVE-2020-1472', platform: 'windows', rank: 'excellent', description: 'Simulates cryptographic failures in AD Netlogon for strategic context assessment.', options: { DC_TARGET: '' } },
  { id: 'v-ldap-01', name: 'LDAP Relay Simulation', cve: 'CVE-2021-42278', platform: 'windows', rank: 'great', description: 'Validates susceptibility to LDAP signing and channel binding bypasses.', options: { RELAY_ADDR: '127.0.0.1' } }
];

interface VulnerabilityValidatorProps {
  connections: WinRMConnection[];
  onExecute: (exploitId: string, targetId: string) => void;
}

const VulnerabilityValidator: React.FC<VulnerabilityValidatorProps> = ({ connections, onExecute }) => {
  const [selectedModule, setSelectedModule] = useState<ExploitModule | null>(null);
  const [selectedTargetId, setSelectedTargetId] = useState('');
  const [isRunning, setIsRunning] = useState(false);
  const [searchTerm, setSearchTerm] = useState('');

  const handleLaunch = () => {
    if (!selectedModule || !selectedTargetId) return;
    setIsRunning(true);
    onExecute(selectedModule.id, selectedTargetId);
    setTimeout(() => setIsRunning(false), 3000);
  };

  const filtered = VALIDATION_LIBRARY.filter(m => m.name.toLowerCase().includes(searchTerm.toLowerCase()));

  return (
    <div className="h-full flex flex-col gap-6 animate-in fade-in duration-500">
      <header className="flex flex-col gap-1">
        <h2 className="text-xl font-black text-red-500 uppercase tracking-tighter flex items-center gap-3">
          <ShieldAlert size={20} /> Strategic Validation Suite
        </h2>
        <p className="text-[10px] text-slate-500 uppercase tracking-widest font-black mt-1">High-Fidelity Vulnerability Research & Impact Assessment</p>
      </header>

      <div className="flex-1 grid grid-cols-1 lg:grid-cols-12 gap-8 overflow-hidden">
        {/* Module Browser */}
        <div className="lg:col-span-4 flex flex-col gap-4 overflow-hidden">
           <div className="relative">
              <Search size={14} className="absolute left-4 top-1/2 -translate-y-1/2 text-slate-600" />
              <input 
                placeholder="Search Validation Modules..." 
                value={searchTerm}
                onChange={e => setSearchTerm(e.target.value)}
                className="w-full bg-black/40 border border-slate-800 rounded-2xl py-3 pl-11 pr-4 text-[10px] font-black uppercase tracking-widest text-slate-400 outline-none focus:border-red-500 transition-all"
              />
           </div>
           <div className="flex-1 overflow-y-auto space-y-3 pr-2 scrollbar-hide">
            {filtered.map(ex => (
              <button
                key={ex.id}
                onClick={() => setSelectedModule(ex)}
                className={`w-full p-6 rounded-[2rem] border transition-all text-left flex flex-col gap-3 relative overflow-hidden group
                  ${selectedModule?.id === ex.id ? 'bg-red-500/10 border-red-500/40 ring-1 ring-red-500/20 shadow-2xl shadow-red-900/20' : 'bg-slate-900/40 border-slate-800 hover:border-slate-700'}`}
              >
                <div className="flex justify-between items-center">
                  <span className="text-[9px] font-black text-red-400 uppercase tracking-widest">{ex.rank} Impact</span>
                  <span className="text-[9px] font-mono text-slate-500">{ex.cve}</span>
                </div>
                <h4 className="text-xs font-black text-slate-100 uppercase leading-tight tracking-tight group-hover:text-red-400 transition-colors">{ex.name}</h4>
                <p className="text-[10px] text-slate-600 line-clamp-2 italic leading-relaxed">{ex.description}</p>
                {selectedModule?.id === ex.id && <div className="absolute bottom-0 right-0 p-4 opacity-5"><ShieldCheck size={48} /></div>}
              </button>
            ))}
          </div>
        </div>

        {/* Workspace */}
        <div className="lg:col-span-8 flex flex-col gap-6 overflow-hidden">
          <section className="bg-[#0b1120] border border-white/5 rounded-[3rem] p-10 flex flex-col relative overflow-hidden flex-1 shadow-2xl">
            {selectedModule ? (
              <>
                <div className="flex justify-between items-start z-10">
                  <div>
                    <h3 className="text-2xl font-black text-slate-100 uppercase tracking-tighter">{selectedModule.name}</h3>
                    <div className="flex items-center gap-4 mt-3">
                       <span className="text-[10px] font-black text-red-500 uppercase tracking-widest px-3 py-1 bg-red-500/10 rounded-lg border border-red-500/20">Authorized Module</span>
                       <span className="text-[10px] font-mono text-slate-500">{selectedModule.cve}</span>
                    </div>
                  </div>
                  <div className="flex flex-col items-end">
                     <span className="text-[8px] font-black text-slate-600 uppercase tracking-widest">Protocol</span>
                     <span className="text-xs font-black text-white uppercase">{selectedModule.platform} Architecture</span>
                  </div>
                </div>

                <div className="mt-12 grid grid-cols-2 gap-10 z-10">
                  <div className="space-y-6">
                    <h4 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-3">
                       <Target size={16} className="text-red-500" /> Assessment Target
                    </h4>
                    <select 
                      value={selectedTargetId}
                      onChange={e => setSelectedTargetId(e.target.value)}
                      className="w-full bg-black/60 border border-slate-800 rounded-2xl p-4 text-xs font-black text-slate-200 uppercase tracking-widest outline-none focus:border-red-500 transition-all"
                    >
                      <option value="">Awaiting Signal Selection...</option>
                      {connections.map(c => (
                        <option key={c.id} value={c.id}>{c.host} ({c.username})</option>
                      ))}
                    </select>
                    <div className="p-5 bg-black/40 border border-white/5 rounded-2xl text-[10px] text-slate-500 leading-relaxed italic">
                       Establishing a validation context on remote assets may trigger environmental telemetry. Ensure Spectral Jitter is active.
                    </div>
                  </div>

                  <div className="space-y-6">
                    <h4 className="text-[11px] font-black text-slate-400 uppercase tracking-[0.2em] flex items-center gap-3">
                       <Settings2 size={16} className="text-blue-500" /> Module Configuration
                    </h4>
                    <div className="space-y-4">
                       {Object.entries(selectedModule.options).map(([key, val]) => (
                        <div key={key} className="space-y-2">
                          <label className="text-[9px] font-black text-slate-600 uppercase tracking-widest">{key}</label>
                          <input 
                            defaultValue={val as string}
                            className="w-full bg-black/60 border border-slate-800 rounded-2xl p-4 text-xs font-mono text-red-400 outline-none focus:border-red-500 transition-all shadow-inner"
                          />
                        </div>
                      ))}
                    </div>
                  </div>
                </div>

                <div className="mt-auto pt-10 border-t border-white/5 flex gap-4 z-10">
                  <button 
                    onClick={handleLaunch}
                    disabled={!selectedTargetId || isRunning}
                    className="flex-1 py-5 bg-red-600 hover:bg-red-500 disabled:opacity-20 text-white rounded-[1.5rem] text-[11px] font-black uppercase tracking-[0.2em] transition-all flex items-center justify-center gap-3 shadow-2xl shadow-red-900/40 active:scale-95"
                  >
                    {isRunning ? <Loader2 size={18} className="animate-spin" /> : <Play size={18} fill="currentColor" />}
                    {isRunning ? 'Validating Vector...' : 'Execute Assessment'}
                  </button>
                  <button className="px-8 py-5 bg-slate-800 hover:bg-slate-700 text-slate-300 rounded-[1.5rem] text-[11px] font-black uppercase tracking-widest transition-all flex items-center gap-3 shadow-inner">
                    <TerminalIcon size={18} />
                    Debug Task
                  </button>
                </div>
              </>
            ) : (
              <div className="h-full flex flex-col items-center justify-center text-slate-800 opacity-20 bg-slate-900/10 border-2 border-dashed border-white/5 rounded-[2rem] p-20">
                <Target size={80} className="mb-6" />
                <p className="text-xs font-black uppercase tracking-[0.5em] text-center leading-loose">Select a Strategic Validation Module to begin assessment</p>
              </div>
            )}
          </section>
        </div>
      </div>
    </div>
  );
};

export default VulnerabilityValidator;
