import { SatelliteVulnerability } from '../types';
import { authService } from './authService';

const BACKEND_URL = 'http://localhost:8000/api/v1';

export const vulnerabilityService = {
  async scanSatellite(noradId: number, satelliteName: string): Promise<SatelliteVulnerability[]> {
    try {
      const response = await authService.makeAuthenticatedRequest(`${BACKEND_URL}/vulnerabilities/scan`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          norad_id: noradId,
          satellite_name: satelliteName
        })
      });

      if (!response.ok) {
        throw new Error('Vulnerability scan failed');
      }

      const data = await response.json();
      return data.vulnerabilities.map((v: any) => ({
        id: v.id,
        cve: v.cve,
        satelliteName: v.satellite_name,
        noradId: v.norad_id,
        subsystem: v.subsystem,
        description: v.description,
        exploitAvailable: v.exploit_available,
        exploitCommand: v.exploit_command,
        mitigation: v.mitigation,
        references: v.references,
        severity: v.severity,
        discoveredDate: v.discovered_date ? new Date(v.discovered_date) : undefined,
        patchAvailable: v.patch_available
      }));
    } catch (error) {
      console.error('Vulnerability scan error:', error);
      return [];
    }
  },

  async getVulnerabilities(noradId?: number): Promise<SatelliteVulnerability[]> {
    try {
      const url = noradId 
        ? `${BACKEND_URL}/vulnerabilities?norad_id=${noradId}`
        : `${BACKEND_URL}/vulnerabilities`;

      const response = await authService.makeAuthenticatedRequest(url);

      if (!response.ok) {
        throw new Error('Failed to fetch vulnerabilities');
      }

      const data = await response.json();
      return data.vulnerabilities.map((v: any) => ({
        id: v.id,
        cve: v.cve,
        satelliteName: v.satellite_name,
        noradId: v.norad_id,
        subsystem: v.subsystem,
        description: v.description,
        exploitAvailable: v.exploit_available,
        exploitCommand: v.exploit_command,
        mitigation: v.mitigation,
        references: v.references,
        severity: v.severity,
        discoveredDate: v.discovered_date ? new Date(v.discovered_date) : undefined,
        patchAvailable: v.patch_available
      }));
    } catch (error) {
      console.error('Failed to fetch vulnerabilities:', error);
      return [];
    }
  }
};
